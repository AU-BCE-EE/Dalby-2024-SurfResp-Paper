labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,700)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, mCH4_C_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_mean - mCH4_C_sd, ymax = mCH4_C_mean + mCH4_C_sd, x = time)) +
facet_grid(comp~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
comp <- mCH4_C_cum_mean
comp <- 'mCH4_C_cum_mean'
comp <- 'mCH4_C_cum_mean'
ggplot(GDout_tb, aes(time, eval(comp), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_mean - mCH4_C_sd, ymax = mCH4_C_mean + mCH4_C_sd, x = time)) +
facet_grid(comp~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
gsub('mean','sd', comp)
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
comp <- 'mCH4_C_cum_mean'
ggplot(GDout_tb, aes(time, eval(comp), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = eval(comp) - eval(gsub('mean','sd', comp)), ymax = eval(comp) + eval(gsub('mean','sd', comp)), x = time)) +
facet_grid(comp~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
eval(gsub('mean','sd', comp))
rm(list=ls())
devtools::install_github('sashahafner/biogas')
library(biogas)
library(readxl)
library(dplyr)
library(ggplot2)
rho_CH4 <- 0.702 # 0 deg C, 1 ATM, kg/m3
rho_CO2 <- 1.802 # 0 deg C, 1 ATM, kg/m3
C_CH4 <- 12.0107/16.042
C_CO2 <- 12.0107/44.009
dat_biogas <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "info")) %>%
filter(day >= 283) %>% select(reactor, gas, temp, day, dm, vs, bio_wet_weight, GD_weight_before, GD_weight_after, mass_vented, vol_vented, room_temp, temp_HS, p_amb) %>%
mutate(time = day - 283)
vs_mass <- dat_biogas %>% filter(time == 0) %>% mutate(vs_mass_load = dm/100 * vs * bio_wet_weight/1000) %>% select(vs_mass_load)
dat_biogas$vs_mass_load <- vs_mass$vs_mass_load
dat <- as.data.frame(dat_biogas)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.1, 0.7), comp.sub = 'lim',
unit.pres = 'mbar')
GDout$mCH4_C <- GDout$vCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C <- (GDout$vBg - GDout$vCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout$mCH4_C_cum <- GDout$cvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C_cum <- (GDout$cvBg - GDout$cvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout_tb <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(mean = mean, sd = sd))) %>%
filter(gas != 0)
View(GDout_tb)
GDout_tb$compound <- 'CH4'
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
comp <- 'mCH4_C_cum_mean'
comp <- 'mCH4_C_cum_mean'
ggplot(GDout_tb, aes(time, eval(comp), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = eval(comp) - eval(gsub('mean','sd', comp)), ymax = eval(comp) + eval(gsub('mean','sd', comp)), x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
gsub('mean','sd', comp)
View(GDout_tb)
ggplot(GDout_tb, aes(time, eval(comp), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = eval(comp) - eval(parse(text = gsub('mean','sd', comp))), ymax = eval(comp) + eval(parse(text = gsub('mean','sd', comp))), x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
parse(text = gsub('mean','sd', comp))
eval(parse(text = gsub('mean','sd', comp)))
comp_mean <- 'mCH4_C_cum_mean'
comp_sd  <- 'mCH4_C_cum_sd'
ggplot(GDout_tb, aes(time, eval(comp_mean), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = eval(comp_mean) - eval(comp_sd), ymax = eval(comp_mean) + eval(comp_sd), x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, expression(comp_mean), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = expression(comp_mean) - expression(comp_sd), ymax = expression(comp_mean) + expression(comp_sd), x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, eval(expression(comp_mean)), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = expression(comp_mean) - expression(comp_sd), ymax = eval(expression(comp_mean)) + eval(expression(comp_sd)), x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, eval(expression(comp_mean)), col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = eval(expression(comp_mean)) - eval(expression(comp_sd)), ymax = eval(expression(comp_mean)) + eval(expression(comp_sd)), x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, mCH4_C_cum_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_cum_mean - mCH4_C_cum_sd, ymax = mCH4_C_cum_mean + mCH4_C_cum_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, mCH4_C_cum_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_cum_mean - mCH4_C_cum_sd, ymax = mCH4_C_cum_mean + mCH4_C_cum_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,300)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
GDout_cum <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(cum = max, sd = sd))) %>%
filter(gas != 0)
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(cum = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.05, 0.9), comp.sub = 'lim',
unit.pres = 'mbar')
GDout$mCH4_C <- GDout$vCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C <- (GDout$vBg - GDout$vCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout$mCH4_C_cum <- GDout$cvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C_cum <- (GDout$cvBg - GDout$cvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout_tb <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(mean = mean, sd = sd))) %>%
filter(gas != 0)
GDout_tb$compound <- 'CH4'
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
comp_mean <- 'mCH4_C_cum_mean'
comp_sd  <- 'mCH4_C_cum_sd'
ggplot(GDout_tb, aes(time, mCH4_C_cum_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_cum_mean - mCH4_C_cum_sd, ymax = mCH4_C_cum_mean + mCH4_C_cum_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,300)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.0, 0.75), comp.sub = 'lim',
unit.pres = 'mbar')
GDout$mCH4_C <- GDout$vCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C <- (GDout$vBg - GDout$vCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout$mCH4_C_cum <- GDout$cvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C_cum <- (GDout$cvBg - GDout$cvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout_tb <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(mean = mean, sd = sd))) %>%
filter(gas != 0)
GDout_tb$compound <- 'CH4'
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
comp_mean <- 'mCH4_C_cum_mean'
comp_sd  <- 'mCH4_C_cum_sd'
ggplot(GDout_tb, aes(time, mCH4_C_cum_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_cum_mean - mCH4_C_cum_sd, ymax = mCH4_C_cum_mean + mCH4_C_cum_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,300)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.1, 0.7), comp.sub = 'lim',
unit.pres = 'mbar')
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
#cumulative emission
rm(list = ls())
library("readxl")
library('ggplot2')
library('tidyr')
library('dplyr')
library('broom')
setwd("C:/Users/au277187/OneDrive - Aarhus universitet/Documents/GitHub/AU-BCE-EE/Dalby-2024-SurfResp-Paper/scripts")
#prep
dat.inf <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "info"))
dat.inf.f <- dat.inf %>% select(c('reactor', 'temp','gas','datetime','day', 'wet_weight', 'dm','vs')) %>%
mutate(dm = dm * 10, vs = vs * dm)
dat.org <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "all"))
mass <- dat.inf.f$wet_weight[dat.inf.f$day == 0]/1000 # kg
mass <- mass[!is.na(mass)]
dat.org <- dat.org[dat.org$reactor != 'bg',]
dat.org$mass <- mass
f_CH4 <- 1/1000000 * dat.org$cor_flow/(0.082057 * 293) * 60 * 24 * 16.04 *1000  # mg pr day
f_CO2 <- 1/1000000 * dat.org$cor_flow/(0.082057 * 293) * 60 * 24 * 44.01 *1000  # mg pr day
CO2_bg <- 430
CH4_bg <- 2
ifelse(dat.org$gas == "air", dat.org$CO2_emis <- (as.numeric(dat.org$co2) - CO2_bg) * f_CO2, dat.org$CO2_emis <- dat.org$co2 * f_CO2)
ifelse(dat.org$gas == "air", dat.org$CH4_emis <- (as.numeric(dat.org$ch4) - CH4_bg) * f_CH4, dat.org$CH4_emis <- dat.org$ch4 * f_CH4)
day_spaced <- seq(from = min(dat.org$date), to = max(dat.org$date),
length.out = max(dat.org$date) - min(dat.org$date) +1)
dat.l <- dat.org %>% group_by(temp) %>% mutate(CH4_emis_C = CH4_emis * 12/16.04, CO2_emis_C = CO2_emis * 12/44.01) %>%
pivot_longer(cols = c('CH4_emis_C', 'CO2_emis_C'),
names_to = 'comp', values_to = 'value')
#add surface respiration rates g day m2
emis.cum.storage <- dat.l %>% group_by(reactor, comp, temp, gas) %>%
mutate(cum = sum(approx(x = date, y = value, xout = day_spaced)$y)) %>%
distinct(cum, keep_all = TRUE) %>%
mutate(cum = cum/1000) %>%
group_by(temp, gas, comp) %>%
summarise(across(cum, .fns = list(mean = mean, sd = sd)))
end.storage <- max(dat.l$day)
emis.stat.storage <- dat.l %>% group_by(reactor, comp, temp, gas) %>%
mutate(cum = sum(approx(x = date, y = value, xout = day_spaced)$y)) %>%
mutate(cum = cum/1000) %>%
summarise(cum = cum[day == end.storage]) %>%
group_by(comp, temp) %>%
do({
fit <- aov(cum ~ gas, data = .)
posthoc <- TukeyHSD(fit)
bind_rows(tidy(fit), tidy(posthoc))
})
## biogas
rho_CH4 <- 0.665 # at 22 deg C, kg/m3
rho_CO2 <- 1.802
dat.info <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "info"))
weights_scale <- dat.info %>% select(wet_weight, day, reactor) %>% filter(day >= 283, day< 283.1) %>%
mutate(weights_scale = wet_weight)
end <- max(dat.info$day)
emis.stat.biogas <- dat.info %>%
select(day, datetime, bio_wet_weight, mass_vented, vol_vented, mass_leaked, x_CH4, reactor, temp, gas) %>%
filter(day > 0) %>% mutate_all(~ ifelse(is.na(.), 0, .), ~ ifelse(.<0, 0, .)) %>%
mutate(mass_leaked = ifelse(mass_leaked < 0, 0, mass_leaked), x_CH4 = ifelse(x_CH4 < 0, 0, ifelse(x_CH4 > 1, 1, x_CH4))) %>% # correct impossible mol fractions and negative leakage
mutate(vol_leak = vol_vented/mass_vented * mass_leaked, vol_vent_leak = vol_leak + vol_vented,
vol_ch4 = vol_vent_leak * x_CH4, vol_co2 = vol_vent_leak * (1 - x_CH4)) %>%
mutate_all(~ ifelse(is.na(.), 0, .), ~ ifelse(.<0, 0, .)) %>%
mutate(weights_scale = rep(weights_scale$weights_scale, length = nrow(dat.info[dat.info$day >= 283,]))) %>%
group_by(reactor) %>%
mutate(cum_CH4 = cumsum(vol_ch4)/bio_wet_weight * weights_scale * rho_CH4/1000 * 12/16.04,
cum_CO2 = cumsum(vol_co2)/bio_wet_weight * weights_scale * rho_CO2/1000 * 12/44.01) %>%
pivot_longer(c('cum_CH4', 'cum_CO2'), names_to = "comp", values_to = "cum") %>%
group_by(reactor, temp, gas, comp) %>% summarise(cum = cum[day == end]) %>%
group_by(comp, temp) %>%
do({
fit <- aov(cum ~ gas, data = .)
posthoc <- TukeyHSD(fit)
bind_rows(tidy(fit), tidy(posthoc))
})
View(emis.stat.biogas)
## combined
emis.cum.storage <- dat.l %>% group_by(reactor, comp, temp, gas) %>%
mutate(cum = sum(approx(x = date, y = value, xout = day_spaced)$y)) %>%
distinct(cum, keep_all = TRUE) %>%
mutate(cum = cum/1000, experiment = "storage") %>% select(-keep_all)
emis.cum.biogas <- dat.info %>%
select(day, datetime, bio_wet_weight, mass_vented, vol_vented, mass_leaked, x_CH4, reactor, temp, gas) %>%
filter(day > 0) %>% mutate_all(~ ifelse(is.na(.), 0, .), ~ ifelse(.<0, 0, .)) %>%
mutate(mass_leaked = ifelse(mass_leaked < 0, 0, mass_leaked), x_CH4 = ifelse(x_CH4 < 0, 0, ifelse(x_CH4 > 1, 1, x_CH4))) %>% # correct impossible mol fractions and negative leakage
mutate(vol_leak = vol_vented/mass_vented * mass_leaked, vol_vent_leak = vol_leak + vol_vented,
vol_ch4 = vol_vent_leak * x_CH4, vol_co2 = vol_vent_leak * (1 - x_CH4)) %>%
mutate_all(~ ifelse(is.na(.), 0, .), ~ ifelse(.<0, 0, .)) %>%
mutate(weights_scale = rep(weights_scale$weights_scale, length = nrow(dat.info[dat.info$day >= 283,]))) %>%
group_by(reactor) %>%
mutate(CH4_emis_C = cumsum(vol_ch4)/bio_wet_weight * weights_scale * rho_CH4/1000 * 12/16,
CO2_emis_C = cumsum(vol_co2)/bio_wet_weight * weights_scale * rho_CO2/1000 * 12/44) %>%
pivot_longer(c('CH4_emis_C', 'CO2_emis_C'), names_to = "comp", values_to = "cum") %>%
mutate(experiment = "biogas") %>%
filter(day == end) %>% select(colnames(emis.cum.storage)) %>% mutate(temp = as.numeric(temp))
View(emis.cum.biogas)
emis.cum.combined <- bind_rows(emis.cum.storage, emis.cum.biogas) %>%
group_by(reactor, temp, gas, comp) %>% summarise(cum = sum(cum)) %>%
mutate(experiment = "combined")
View(emis.cum.combined)
View(emis.cum.biogas)
summary <- emiscum.biogas %>% group_by(temp, gas, comp) %>% summarise(max(cum))
summary <- emis.cum.biogas %>% group_by(temp, gas, comp) %>% summarise(max(cum))
View(summary)
summary <- emis.cum.biogas %>% group_by(temp, gas, comp) %>% summarise(max(cum)/0.089675)
View(summary)
rho_CH4 <- 0.702 # 0 deg C, 1 ATM, kg/m3
rho_CO2 <- 1.802 # 0 deg C, 1 ATM, kg/m3
C_CH4 <- 12.0107/16.042
C_CO2 <- 12.0107/44.009
dat_biogas <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "info")) %>%
filter(day >= 283) %>% select(reactor, gas, temp, day, dm, vs, bio_wet_weight, GD_weight_before, GD_weight_after, mass_vented, vol_vented, room_temp, temp_HS, p_amb) %>%
mutate(time = day - 283)
vs_mass <- dat_biogas %>% filter(time == 0) %>% mutate(vs_mass_load = dm/100 * vs * bio_wet_weight/1000) %>% select(vs_mass_load)
dat_biogas$vs_mass_load <- vs_mass$vs_mass_load
dat <- as.data.frame(dat_biogas)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.1, 0.7), comp.sub = 'lim',
unit.pres = 'mbar')
devtools::install_github('sashahafner/biogas')
library(biogas)
library(readxl)
library(dplyr)
library(ggplot2)
rho_CH4 <- 0.702 # 0 deg C, 1 ATM, kg/m3
rho_CO2 <- 1.802 # 0 deg C, 1 ATM, kg/m3
C_CH4 <- 12.0107/16.042
C_CO2 <- 12.0107/44.009
dat_biogas <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "info")) %>%
filter(day >= 283) %>% select(reactor, gas, temp, day, dm, vs, bio_wet_weight, GD_weight_before, GD_weight_after, mass_vented, vol_vented, room_temp, temp_HS, p_amb) %>%
mutate(time = day - 283)
vs_mass <- dat_biogas %>% filter(time == 0) %>% mutate(vs_mass_load = dm/100 * vs * bio_wet_weight/1000) %>% select(vs_mass_load)
dat_biogas$vs_mass_load <- vs_mass$vs_mass_load
dat <- as.data.frame(dat_biogas)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.1, 0.7), comp.sub = 'lim',
unit.pres = 'mbar')
GDout$mCH4_C <- GDout$vCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C <- (GDout$vBg - GDout$vCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout$mCH4_C_cum <- GDout$cvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C_cum <- (GDout$cvBg - GDout$cvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout_tb <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(mean = mean, sd = sd))) %>%
filter(gas != 0)
GDout_tb$compound <- 'CH4'
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
comp_mean <- 'mCH4_C_cum_mean'
comp_sd  <- 'mCH4_C_cum_sd'
ggplot(GDout_tb, aes(time, mCH4_C_cum_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_cum_mean - mCH4_C_cum_sd, ymax = mCH4_C_cum_mean + mCH4_C_cum_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,300)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
View(summary)
View(GDout_tb)
View(summary)
View(GDout_cum)
View(summary)
View(GDout_tb)
View(summary)
View(GDout_cum)
View(summary)
View(GDout_cum)
89 + 126
107+80
96.83+64.66
84.97+104.5
189.47-161.49
215-187
31.47 + 59.83
35.7+41.6
91.3-77.3
23.77+42.7855
8.91+75.04
66.5555-83.95
rm(list=ls())
devtools::install_github('sashahafner/biogas')
library(biogas)
library(readxl)
library(dplyr)
library(ggplot2)
rho_CH4 <- 0.702 # 0 deg C, 1 ATM, kg/m3
rho_CO2 <- 1.802 # 0 deg C, 1 ATM, kg/m3
C_CH4 <- 12.0107/16.042
C_CO2 <- 12.0107/44.009
dat_biogas <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "info")) %>%
filter(day >= 283) %>% select(reactor, gas, temp, day, dm, vs, bio_wet_weight, GD_weight_before, GD_weight_after, mass_vented, vol_vented, room_temp, temp_HS, p_amb) %>%
mutate(time = day - 283)
vs_mass <- dat_biogas %>% filter(time == 0) %>% mutate(vs_mass_load = dm/100 * vs * bio_wet_weight/1000) %>% select(vs_mass_load)
dat_biogas$vs_mass_load <- vs_mass$vs_mass_load
dat <- as.data.frame(dat_biogas)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.1, 0.7), comp.sub = 'lim',
unit.pres = 'mbar')
GDout$mCH4_C <- GDout$vCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C <- (GDout$vBg - GDout$vCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout$mCH4_C_cum <- GDout$cvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C_cum <- (GDout$cvBg - GDout$cvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout_tb <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(mean = mean, sd = sd))) %>%
filter(gas != 0)
GDout_tb$compound <- 'CH4'
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
comp_mean <- 'mCH4_C_mean'
comp_sd  <- 'mCH4_C_sd'
ggplot(GDout_tb, aes(time, mCH4_C_cum_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_cum_mean - mCH4_C_cum_sd, ymax = mCH4_C_cum_mean + mCH4_C_cum_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,300)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, mCH4_C_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_mean - mCH4_C_sd, ymax = mCH4_C_mean + mCH4_C_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,300)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, mCH4_C_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_mean - mCH4_C_sd, ymax = mCH4_C_mean + mCH4_C_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,5)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
ggplot(GDout_tb, aes(time, mCH4_C_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_mean - mCH4_C_sd, ymax = mCH4_C_mean + mCH4_C_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,6)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
?calcBgGD
rm(list=ls())
devtools::install_github('sashahafner/biogas')
library(biogas)
library(readxl)
library(dplyr)
library(ggplot2)
rho_CH4 <- 0.702 # 0 deg C, 1 ATM, kg/m3
rho_CO2 <- 1.977 # 0 deg C, 1 ATM, kg/m3
C_CH4 <- 12.0107/16.042
C_CO2 <- 12.0107/44.009
dat_biogas <- data.frame(read_excel("../data/dat_resp.xlsx", sheet = "info")) %>%
filter(day >= 283) %>% select(reactor, gas, temp, day, dm, vs, bio_wet_weight, GD_weight_before, GD_weight_after, mass_vented, vol_vented, room_temp, temp_HS, p_amb) %>%
mutate(time = day - 283)
vs_mass <- dat_biogas %>% filter(time == 0) %>% mutate(vs_mass_load = dm/100 * vs * bio_wet_weight/1000) %>% select(vs_mass_load)
dat_biogas$vs_mass_load <- vs_mass$vs_mass_load
dat <- as.data.frame(dat_biogas)
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.1, 0.7), comp.sub = 'lim',
unit.pres = 'mbar')
GDout$mCH4_C <- GDout$vCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C <- (GDout$vBg - GDout$vCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout$mCH4_C_cum <- GDout$cvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C_cum <- (GDout$cvBg - GDout$cvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout_tb <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(mean = mean, sd = sd))) %>%
filter(gas != 0)
GDout_tb$compound <- 'CH4'
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
ggplot(GDout_tb, aes(time, mCH4_C_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_mean - mCH4_C_sd, ymax = mCH4_C_mean + mCH4_C_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,6)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
?calcBgGD
GDout <- calcBgGD(dat, temp.vol = 22, temp.grav = 34, pres.vol = 'p_amb', pres.grav = 1500,
id.name = 'reactor', vol.name = 'vol_vented', m.pre.name = 'GD_weight_before', m.post.name = 'GD_weight_after',
time.name = 'time', comp.name = 'xCH4',
vented.mass = TRUE, averaging = 'final', vmethod = 'grav',
extrap = TRUE,
addt0 = TRUE, showt0 = TRUE, comp.lim = c(0.1, 0.7), comp.sub = 'lim',
unit.pres = 'mbar')
GDout$mCH4_C <- GDout$rvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C <- (GDout$rvBg - GDout$rvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout$mCH4_C_cum <- GDout$cvCH4 * rho_CH4/1000 * C_CH4/GDout$vs_mass_load
GDout$mCO2_C_cum <- (GDout$cvBg - GDout$cvCH4) * rho_CO2/1000 * C_CO2/GDout$vs_mass_load
GDout_tb <- GDout %>% group_by(gas, temp, time) %>%
summarize(across(c(mCH4_C, mCO2_C, mCH4_C_cum, mCO2_C_cum), .fns = list(mean = mean, sd = sd))) %>%
filter(gas != 0)
GDout_tb$compound <- 'CH4'
new.lab = as_labeller(c(air = 'Air', n2 = 'N[2]', CH4 = 'CH[4]'), label_parsed)
ggplot(GDout_tb, aes(time, mCH4_C_mean, col = temp)) + geom_line() + geom_point() +
geom_errorbar(aes(ymin = mCH4_C_mean - mCH4_C_sd, ymax = mCH4_C_mean + mCH4_C_sd, x = time)) +
facet_grid(compound~gas) +
labs(y = expression('Emission rate (g C kg'^{-1}~VS~'d'^{-1}*')'), x = 'Time (d)', col  = expression('Temp (\u00b0C)'), tag = 'b') +
coord_cartesian(ylim = c(0,6)) +
theme_bw() + theme(legend.position = '', axis.title.y = element_text(size = 10)) + scale_color_manual(values = c("blue", "red"))
GDout_cum <- GDout %>% group_by(gas, temp) %>%
summarize(across(c(mCH4_C_cum, mCO2_C_cum), .fns = list(max = max, sd = sd))) %>%
filter(gas != 0)
View(GDout_cum)
